  name: Deploy to VPS

  on:
    push:
      branches: [main]

  jobs:
    deploy:
      runs-on: ubuntu-latest
      environment: VPS
      steps:
        - uses: actions/checkout@v4

        - name: Fetch PIKA changelog
          run: |
            curl -sf -H "Authorization: token ${{ secrets.PIKA_REPO_TOKEN }}" \
              -H "Accept: application/vnd.github.v3.raw" \
              "https://api.github.com/repos/ForceSensitiveSaiyan/pika/contents/CHANGELOG.md" \
              -o CHANGELOG.md

        - name: Build changelog page
          run: python build-changelog.py --changelog CHANGELOG.md

        - name: Deploy via rsync
          env:
            SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          run: |
            mkdir -p ~/.ssh
            echo "$SSH_KEY" > ~/.ssh/deploy_key
            chmod 600 ~/.ssh/deploy_key
            ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

            rsync -avz --delete \
              -e "ssh -i ~/.ssh/deploy_key" \
              --exclude='.git' \
              --exclude='.github' \
              --exclude='README.md' \
              --exclude='logo_designs.png' \
              --exclude='build-changelog.py' \
              --exclude='CHANGELOG.md' \
              --exclude='nul' \
              --exclude='api/' \
              ./ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/var/www/aidoo.biz/

    deploy-api:
      needs: deploy
      runs-on: ubuntu-latest
      environment: VPS
      steps:
        - uses: actions/checkout@v4

        - name: Deploy API to VPS
          env:
            SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          run: |
            mkdir -p ~/.ssh
            echo "$SSH_KEY" > ~/.ssh/deploy_key
            chmod 600 ~/.ssh/deploy_key
            ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

            rsync -avz \
              -e "ssh -i ~/.ssh/deploy_key" \
              api/ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/opt/aidoo-api/

        - name: Install dependencies and restart service
          env:
            SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          run: |
            ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
              "/opt/aidoo-api/venv/bin/pip install -q -r /opt/aidoo-api/requirements.txt && sudo systemctl restart aidoo-api"
